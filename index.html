<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Prayer Times - Jadwal Sholat Indonesia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #10b981;
            --dark: #1e293b;
            --light: #f8fafc;
        }
        
        .dark {
            --primary: #60a5fa;
            --secondary: #34d399;
            --dark: #f8fafc;
            --light: #1e293b;
        }
        
        .neon-text {
            text-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary), 0 0 20px var(--primary);
        }
        
        .neon-box {
            box-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary);
        }
        
        .neon-box-secondary {
            box-shadow: 0 0 10px var(--secondary), 0 0 20px var(--secondary);
        }
        
        .glow {
            animation: glow 2s infinite alternate;
        }
        
        @keyframes glow {
            from {
                box-shadow: 0 0 5px var(--primary);
            }
            to {
                box-shadow: 0 0 20px var(--primary);
            }
        }
        
        #particles-js {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
        }
        
        .content {
            position: relative;
            z-index: 1;
        }
        
        .prayer-card {
            transition: all 0.3s ease;
            transform-style: preserve-3d;
        }
        
        .prayer-card:hover {
            transform: translateY(-5px) scale(1.02);
        }
        
        .active-prayer {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }
        
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 transition-colors duration-300 min-h-screen">
    <div id="particles-js"></div>
    <div class="content container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-2">
                <i class="fas fa-mosque text-3xl text-blue-500"></i>
                <h1 class="text-2xl font-bold neon-text">Quantum<span class="text-emerald-500">Prayer</span></h1>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <select id="city-select" class="bg-white dark:bg-slate-800 border border-blue-500 dark:border-blue-400 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none pr-8">
                        <option value="">Pilih Kota...</option>
                        <!-- Cities will be populated by JavaScript -->
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                        <i class="fas fa-chevron-down text-blue-500"></i>
                    </div>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full bg-blue-500 text-white dark:bg-emerald-500 hover:bg-blue-600 dark:hover:bg-emerald-600 transition-colors">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:block"></i>
                </button>
            </div>
        </header>

        <!-- Current Time and Date -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 mb-8 neon-box transition-all duration-300">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="text-center md:text-left mb-4 md:mb-0">
                    <h2 class="text-2xl font-bold text-blue-500" id="current-date">Senin, 1 Januari 2023</h2>
                    <p class="text-lg text-emerald-500" id="hijri-date">1 Muharram 1445 H</p>
                </div>
                <div class="text-center">
                    <div class="text-5xl font-bold text-blue-500" id="current-time">00:00:00</div>
                    <div class="text-lg text-emerald-500" id="current-prayer">Waktu Sholat Saat Ini: -</div>
                </div>
            </div>
        </div>

        <!-- Prayer Times Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Cards will be populated by JavaScript -->
        </div>

        <!-- Next Prayer Countdown -->
        <div class="bg-gradient-to-r from-blue-500 to-emerald-500 rounded-xl shadow-lg p-6 mb-8 neon-box-secondary">
            <h2 class="text-2xl font-bold text-white mb-4">Waktu Sholat Berikutnya</h2>
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="text-center md:text-left mb-4 md:mb-0">
                    <h3 class="text-xl font-semibold text-white" id="next-prayer-name">-</h3>
                    <p class="text-white" id="next-prayer-time">-</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative w-16 h-16">
                        <svg class="w-full h-full" viewBox="0 0 36 36">
                            <path
                                d="M18 2.0845
                                    a 15.9155 15.9155 0 0 1 0 31.831
                                    a 15.9155 15.9155 0 0 1 0 -31.831"
                                fill="none"
                                stroke="rgba(255,255,255,0.2)"
                                stroke-width="3"
                            />
                            <path
                                id="countdown-circle"
                                d="M18 2.0845
                                    a 15.9155 15.9155 0 0 1 0 31.831
                                    a 15.9155 15.9155 0 0 1 0 -31.831"
                                fill="none"
                                stroke="white"
                                stroke-width="3"
                                stroke-dasharray="100, 100"
                            />
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-white font-bold text-lg" id="countdown-text">00:00</span>
                        </div>
                    </div>
                    <div class="text-white">
                        <p class="text-sm">Tersisa:</p>
                        <p class="text-xl font-bold" id="countdown-timer">00:00:00</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Location Info -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 neon-box transition-all duration-300">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center space-x-4 mb-4 md:mb-0">
                    <i class="fas fa-map-marker-alt text-3xl text-blue-500"></i>
                    <div>
                        <h3 class="text-xl font-bold" id="location-name">Lokasi Terdeteksi</h3>
                        <p class="text-emerald-500" id="location-coords">Koordinat: -</p>
                    </div>
                </div>
                <button id="refresh-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2">
                    <i class="fas fa-sync-alt"></i>
                    <span>Refresh Data</span>
                </button>
            </div>
        </div>
    </div>

    <footer class="bg-white dark:bg-slate-800 py-6 mt-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-slate-600 dark:text-slate-300">QuantumPrayer &copy; 2023 - Jadwal Sholat Indonesia</p>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">Data disediakan oleh <a href="https://api.myquran.com" class="text-blue-500 hover:underline" target="_blank">myQuran API</a></p>
        </div>
    </footer>

    <script>
        // DOM Elements
        const themeToggle = document.getElementById('theme-toggle');
        const citySelect = document.getElementById('city-select');
        const refreshBtn = document.getElementById('refresh-btn');
        const currentTimeEl = document.getElementById('current-time');
        const currentDateEl = document.getElementById('current-date');
        const hijriDateEl = document.getElementById('hijri-date');
        const currentPrayerEl = document.getElementById('current-prayer');
        const nextPrayerNameEl = document.getElementById('next-prayer-name');
        const nextPrayerTimeEl = document.getElementById('next-prayer-time');
        const countdownTextEl = document.getElementById('countdown-text');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const countdownCircle = document.getElementById('countdown-circle');
        const locationNameEl = document.getElementById('location-name');
        const locationCoordsEl = document.getElementById('location-coords');
        const prayerTimesGrid = document.querySelector('.grid');

        // Global Variables
        let prayerTimes = [];
        let cities = [];
        let currentCity = null;
        let currentLocation = null;
        let nextPrayer = null;
        let currentPrayer = null;
        let countdownInterval = null;
        let timeUpdateInterval = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initParticles();
            loadCities();
            setupEventListeners();
            updateDateTime();
            detectLocation();
        });

        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.classList.toggle('dark', savedTheme === 'dark');
            localStorage.setItem('theme', savedTheme);
        }

        themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        // Particles.js Background
        function initParticles() {
            particlesJS('particles-js', {
                "particles": {
                    "number": {
                        "value": 80,
                        "density": {
                            "enable": true,
                            "value_area": 800
                        }
                    },
                    "color": {
                        "value": "#3b82f6"
                    },
                    "shape": {
                        "type": "circle",
                        "stroke": {
                            "width": 0,
                            "color": "#000000"
                        },
                        "polygon": {
                            "nb_sides": 5
                        }
                    },
                    "opacity": {
                        "value": 0.5,
                        "random": false,
                        "anim": {
                            "enable": false,
                            "speed": 1,
                            "opacity_min": 0.1,
                            "sync": false
                        }
                    },
                    "size": {
                        "value": 3,
                        "random": true,
                        "anim": {
                            "enable": false,
                            "speed": 40,
                            "size_min": 0.1,
                            "sync": false
                        }
                    },
                    "line_linked": {
                        "enable": true,
                        "distance": 150,
                        "color": "#3b82f6",
                        "opacity": 0.4,
                        "width": 1
                    },
                    "move": {
                        "enable": true,
                        "speed": 2,
                        "direction": "none",
                        "random": false,
                        "straight": false,
                        "out_mode": "out",
                        "bounce": false,
                        "attract": {
                            "enable": false,
                            "rotateX": 600,
                            "rotateY": 1200
                        }
                    }
                },
                "interactivity": {
                    "detect_on": "canvas",
                    "events": {
                        "onhover": {
                            "enable": true,
                            "mode": "grab"
                        },
                        "onclick": {
                            "enable": true,
                            "mode": "push"
                        },
                        "resize": true
                    },
                    "modes": {
                        "grab": {
                            "distance": 140,
                            "line_linked": {
                                "opacity": 1
                            }
                        },
                        "bubble": {
                            "distance": 400,
                            "size": 40,
                            "duration": 2,
                            "opacity": 8,
                            "speed": 3
                        },
                        "repulse": {
                            "distance": 200,
                            "duration": 0.4
                        },
                        "push": {
                            "particles_nb": 4
                        },
                        "remove": {
                            "particles_nb": 2
                        }
                    }
                },
                "retina_detect": true
            });
        }

        // Load Indonesian Cities
        async function loadCities() {
            try {
                const response = await fetch('https://api.myquran.com/v1/sholat/kota/semua');
                const data = await response.json();
                cities = data;
                
                // Populate city select dropdown
                citySelect.innerHTML = '<option value="">Pilih Kota...</option>';
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.id;
                    option.textContent = city.lokasi;
                    citySelect.appendChild(option);
                });
                
                // Set default to Jakarta if location detection fails
                if (!currentCity) {
                    const jakarta = cities.find(city => city.lokasi.includes('Jakarta'));
                    if (jakarta) {
                        citySelect.value = jakarta.id;
                        currentCity = jakarta;
                        fetchPrayerTimes(jakarta.id);
                    }
                }
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        }

        // Fetch Prayer Times
        async function fetchPrayerTimes(cityId) {
            try {
                const today = new Date();
                const dateStr = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
                const response = await fetch(`https://api.myquran.com/v1/sholat/jadwal/${cityId}/${dateStr}`);
                const data = await response.json();
                
                if (data.status) {
                    prayerTimes = data.data.jadwal;
                    currentLocation = data.data.lokasi;
                    updatePrayerTimesUI();
                    startPrayerTimeTracking();
                }
            } catch (error) {
                console.error('Error fetching prayer times:', error);
            }
        }

        // Update Prayer Times UI
        function updatePrayerTimesUI() {
            if (!prayerTimes || !currentLocation) return;
            
            // Update location info
            locationNameEl.textContent = currentLocation;
            locationCoordsEl.textContent = `Koordinat: ${prayerTimes.lintang} ${prayerTimes.bujur}`;
            
            // Clear previous cards
            prayerTimesGrid.innerHTML = '';
            
            // Create prayer time cards
            const prayers = [
                { name: 'Subuh', time: prayerTimes.subuh, icon: 'fa-moon' },
                { name: 'Dzuhur', time: prayerTimes.dzuhur, icon: 'fa-sun' },
                { name: 'Ashar', time: prayerTimes.ashar, icon: 'fa-cloud-sun' },
                { name: 'Maghrib', time: prayerTimes.maghrib, icon: 'fa-sunset' },
                { name: 'Isya', time: prayerTimes.isya, icon: 'fa-stars' },
                { name: 'Imsak', time: prayerTimes.imsak, icon: 'fa-clock' }
            ];
            
            prayers.forEach(prayer => {
                const isActive = currentPrayer === prayer.name;
                const card = document.createElement('div');
                card.className = `prayer-card bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 flex flex-col items-center ${isActive ? 'active-prayer border-2 border-blue-500' : ''} fade-in`;
                card.innerHTML = `
                    <div class="w-16 h-16 rounded-full bg-blue-500 text-white flex items-center justify-center mb-4 ${isActive ? 'glow' : ''}">
                        <i class="fas ${prayer.icon} text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">${prayer.name}</h3>
                    <p class="text-2xl font-bold text-blue-500">${prayer.time}</p>
                    ${prayer.name === 'Imsak' ? '<p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Waktu mulai puasa</p>' : ''}
                `;
                prayerTimesGrid.appendChild(card);
            });
        }

        // Update Date and Time
        function updateDateTime() {
            const now = new Date();
            
            // Format current time
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            currentTimeEl.textContent = now.toLocaleTimeString('id-ID', timeOptions);
            
            // Format current date
            const dateOptions = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            currentDateEl.textContent = now.toLocaleDateString('id-ID', dateOptions);
            
            // Calculate Hijri date (simplified)
            const hijriDate = convertToHijri(now);
            hijriDateEl.textContent = hijriDate;
            
            // Schedule next update
            timeUpdateInterval = setTimeout(updateDateTime, 1000);
        }

        // Simplified Hijri date conversion
        function convertToHijri(gregorianDate) {
            // This is a simplified approximation - for accurate dates, use a proper library
            const gregYear = gregorianDate.getFullYear();
            const gregMonth = gregorianDate.getMonth() + 1;
            const gregDay = gregorianDate.getDate();
            
            // Approximate conversion (1 day = 1.030684 days)
            const hijriEpoch = 227015; // Days since 1 Muharram 1 AH (Julian day 1948439.5)
            const gregEpoch = new Date(622, 6, 16).getTime(); // July 16, 622 CE (Gregorian)
            const diffDays = Math.floor((gregorianDate.getTime() - gregEpoch) / (1000 * 60 * 60 * 24));
            const hijriDays = Math.floor(diffDays * 0.970224) + 1;
            
            const hijriYear = Math.floor(hijriDays / 354.366);
            const remainingDays = hijriDays % 354.366;
            
            // Hijri months (alternating 29/30 days except for Dhu al-Hijjah)
            const hijriMonths = [
                { name: 'Muharram', days: 30 },
                { name: 'Safar', days: 29 },
                { name: 'Rabiul Awal', days: 30 },
                { name: 'Rabiul Akhir', days: 29 },
                { name: 'Jumadil Awal', days: 30 },
                { name: 'Jumadil Akhir', days: 29 },
                { name: 'Rajab', days: 30 },
                { name: 'Sya\'ban', days: 29 },
                { name: 'Ramadhan', days: 30 },
                { name: 'Syawal', days: 29 },
                { name: 'Dzulqa\'dah', days: 30 },
                { name: 'Dzulhijjah', days: (hijriYear % 30 === 0 || hijriYear % 30 === 2 || hijriYear % 30 === 5 || hijriYear % 30 === 7 || hijriYear % 30 === 10 || hijriYear % 30 === 13 || hijriYear % 30 === 16 || hijriYear % 30 === 18 || hijriYear % 30 === 21 || hijriYear % 30 === 24 || hijriYear % 30 === 26 || hijriYear % 30 === 29) ? 30 : 29 }
            ];
            
            let dayCount = remainingDays;
            let hijriMonth = 0;
            let hijriDay = 0;
            
            for (let i = 0; i < hijriMonths.length; i++) {
                if (dayCount <= hijriMonths[i].days) {
                    hijriMonth = i;
                    hijriDay = Math.floor(dayCount);
                    break;
                }
                dayCount -= hijriMonths[i].days;
            }
            
            return `${hijriDay + 1} ${hijriMonths[hijriMonth].name} ${hijriYear + 1} H`;
        }

        // Track Prayer Times
        function startPrayerTimeTracking() {
            if (!prayerTimes) return;
            
            clearInterval(countdownInterval);
            
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const prayerTimesList = [
                { name: 'Subuh', time: prayerTimes.subuh },
                { name: 'Dzuhur', time: prayerTimes.dzuhur },
                { name: 'Ashar', time: prayerTimes.ashar },
                { name: 'Maghrib', time: prayerTimes.maghrib },
                { name: 'Isya', time: prayerTimes.isya }
            ];
            
            // Convert prayer times to minutes since midnight
            const prayersInMinutes = prayerTimesList.map(prayer => {
                const [hours, minutes] = prayer.time.split(':').map(Number);
                return {
                    name: prayer.name,
                    minutes: hours * 60 + minutes
                };
            });
            
            // Find current and next prayer
            let nextPrayerIndex = prayersInMinutes.findIndex(prayer => prayer.minutes > currentTime);
            
            if (nextPrayerIndex === -1) {
                // All prayers passed for today, next is tomorrow's Subuh
                nextPrayerIndex = 0;
                nextPrayer = {
                    name: prayersInMinutes[nextPrayerIndex].name,
                    minutes: prayersInMinutes[nextPrayerIndex].minutes + 1440 // Add 24 hours
                };
                currentPrayer = prayersInMinutes[prayersInMinutes.length - 1].name;
            } else {
                nextPrayer = prayersInMinutes[nextPrayerIndex];
                currentPrayer = nextPrayerIndex === 0 ? 
                    prayersInMinutes[prayersInMinutes.length - 1].name : 
                    prayersInMinutes[nextPrayerIndex - 1].name;
            }
            
            // Update UI
            currentPrayerEl.textContent = `Waktu Sholat Saat Ini: ${currentPrayer}`;
            nextPrayerNameEl.textContent = nextPrayer.name;
            nextPrayerTimeEl.textContent = formatTimeFromMinutes(nextPrayer.minutes % 1440);
            
            // Start countdown
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        // Update Countdown to Next Prayer
        function updateCountdown() {
            if (!nextPrayer) return;
            
            const now = new Date();
            const currentTime = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            const nextPrayerTime = (nextPrayer.minutes % 1440) * 60;
            
            let diff = nextPrayerTime - currentTime;
            
            if (diff < 0) {
                // Next prayer is tomorrow
                diff += 24 * 3600;
            }
            
            const hours = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            const seconds = diff % 60;
            
            // Update countdown timer
            countdownTimerEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            countdownTextEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            
            // Update progress circle
            const totalTime = nextPrayer.minutes - ((now.getHours() * 60) + now.getMinutes());
            const progress = 100 - ((diff / (totalTime * 60)) * 100);
            const circumference = 2 * Math.PI * 15.9155;
            const offset = circumference - (progress / 100) * circumference;
            
            countdownCircle.setAttribute('stroke-dasharray', `${circumference}`);
            countdownCircle.setAttribute('stroke-dashoffset', `${offset}`);
            
            // Check if we've reached the next prayer time
            if (diff <= 0) {
                clearInterval(countdownInterval);
                startPrayerTimeTracking();
            }
        }

        // Format time from minutes
        function formatTimeFromMinutes(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
        }

        // Detect User Location
        function detectLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude, longitude } = position.coords;
                        locationCoordsEl.textContent = `Koordinat: ${latitude.toFixed(4)}° N, ${longitude.toFixed(4)}° E`;
                        
                        // Find nearest city (simplified - in a real app, you'd use a geocoding API)
                        findNearestCity(latitude, longitude);
                    },
                    error => {
                        console.error('Geolocation error:', error);
                        locationNameEl.textContent = 'Lokasi tidak dapat ditentukan';
                        locationCoordsEl.textContent = 'Gunakan dropdown untuk memilih kota';
                    }
                );
            } else {
                locationNameEl.textContent = 'Geolocation tidak didukung';
                locationCoordsEl.textContent = 'Gunakan dropdown untuk memilih kota';
            }
        }

        // Find nearest city from coordinates (simplified)
        function findNearestCity(lat, lng) {
            // In a real app, you would use a proper geocoding API
            // This is a simplified version that just finds the city with coordinates closest to the user
            
            if (!cities.length) return;
            
            let nearestCity = cities[0];
            let minDistance = Infinity;
            
            cities.forEach(city => {
                // Some cities in the API have coordinates in the format "6°10' LS 106°49' BT"
                // This is a very simplified parser - in reality you'd need proper parsing
                const latMatch = city.lintang.match(/(\d+)°(\d+)'/);
                const lngMatch = city.bujur.match(/(\d+)°(\d+)'/);
                
                if (latMatch && lngMatch) {
                    const cityLat = parseInt(latMatch[1]) + (parseInt(latMatch[2]) / 60);
                    const cityLng = parseInt(lngMatch[1]) + (parseInt(lngMatch[2]) / 60);
                    
                    // Simple distance calculation (not accurate for Earth's curvature)
                    const distance = Math.sqrt(Math.pow(cityLat - lat, 2) + Math.pow(cityLng - lng, 2));
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestCity = city;
                    }
                }
            });
            
            currentCity = nearestCity;
            citySelect.value = nearestCity.id;
            fetchPrayerTimes(nearestCity.id);
        }

        // Event Listeners
        function setupEventListeners() {
            citySelect.addEventListener('change', (e) => {
                if (e.target.value) {
                    currentCity = cities.find(city => city.id == e.target.value);
                    fetchPrayerTimes(e.target.value);
                }
            });
            
            refreshBtn.addEventListener('click', () => {
                if (currentCity) {
                    fetchPrayerTimes(currentCity.id);
                } else {
                    detectLocation();
                }
            });
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            clearInterval(countdownInterval);
            clearTimeout(timeUpdateInterval);
        });
    </script>
</body>
</html>